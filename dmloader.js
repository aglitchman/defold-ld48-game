var FileLoader={options:{retryCount:4,retryInterval:1e3},request:function(e,i,s,a){if(void 0===i)throw"No method specified";if("responseType"==typeof i)throw"No responseType specified";void 0===a&&(a=0);var d={send:function(){var o=this.onprogress,n=this.onload,t=this.onerror,r=new XMLHttpRequest;r.open(i,e,!0),r.responseType=s,r.onprogress=function(e){o&&o(r,e)},r.onerror=function(e){a!=FileLoader.options.retryCount?(a+=1,setTimeout(d.send.bind(d),FileLoader.options.retryInterval)):t&&t(r,e)},r.onload=function(e){n&&n(r,e)},r.send(null)}};return d},size:function(e,n){e=FileLoader.request(e,"HEAD","text");e.onerror=function(e,o){n(void 0)},e.onload=function(e,o){4===e.readyState&&(200===e.status?(e=e.getResponseHeader("content-length"),n(e)):n(void 0))},e.send()},load:function(n,t,r,i,s,a){var e=FileLoader.request(n,"GET",t);e.onprogress=function(e,o){o.lengthComputable?i(o.loaded,o.total):(e=null!=(e=e.getResponseHeader("content-length"))?e:r,i(o.loaded,e||o.loaded))},e.onerror=function(e,o){s("Error loading '"+n+"' ("+o+")")},e.onload=function(e,o){4===e.readyState&&(200===e.status?(e=e.response,a("json"==t&&"string"==typeof e?JSON.parse(e):e)):s("Error loading '"+n+"' ("+o+")"))},e.send()}},EngineLoader={wasm_size:2e6,wasm_from:0,wasm_to:40,wasmjs_size:25e4,wasmjs_from:40,wasmjs_to:50,asmjs_size:4e6,asmjs_from:0,asmjs_to:50,loadWasmAsync:function(e,n,t,o){FileLoader.load(e,"arraybuffer",EngineLoader.wasm_size,function(e,o){Progress.calculateProgress(n,t,e,o)},function(e){throw e},function(n){Module.instantiateWasm=function(e,o){WebAssembly.instantiate(new Uint8Array(n),e).then(function(e){o(e.instance)}).catch(function(e){throw console.log("wasm instantiation failed! "+e),e});return{}},o()})},loadScriptAsync:function(e,o,n,t){FileLoader.load(e,"text",o,function(e,o){Progress.calculateProgress(n,t,e,o)},function(e){throw e},function(e){var o=document.createElement("script");o.text=e,document.head.appendChild(o)})},load:function(e,o){Progress.addProgress(Module.setupCanvas(e)),Module.isWASMSupported?EngineLoader.loadWasmAsync(o+".wasm",EngineLoader.wasm_from,EngineLoader.wasm_to,function(e){EngineLoader.loadScriptAsync(o+"_wasm.js",EngineLoader.wasmjs_size,EngineLoader.wasmjs_from,EngineLoader.wasmjs_to)}):EngineLoader.loadScriptAsync(o+"_asmjs.js",EngineLoader.asmjs_size,EngineLoader.asmjs_from,EngineLoader.asmjs_to)}},GameArchiveLoader={_files:[],_fileIndex:0,isCompleted:!1,_onFileLoadedListeners:[],_onArchiveLoadedListeners:[],_onFileDownloadErrorListeners:[],_currentDownloadBytes:0,_totalDownloadBytes:0,_archiveLocationFilter:function(e){return"split"+e},cleanUp:function(){this._files=[],this._fileIndex=0,this.isCompleted=!1,this._onGameArchiveLoaderCompletedListeners=[],this._onAllTargetsBuiltListeners=[],this._onFileDownloadErrorListeners=[],this._currentDownloadBytes=0,this._totalDownloadBytes=0},addListener:function(e,o){if("function"!=typeof o)throw"Invalid callback registration";e.push(o)},notifyListeners:function(e,o){for(i=0;i<e.length;++i)e[i](o)},addFileDownloadErrorListener:function(e){this.addListener(this._onFileDownloadErrorListeners,e)},notifyFileDownloadError:function(e){this.notifyListeners(this._onFileDownloadErrorListeners,e)},addFileLoadedListener:function(e){this.addListener(this._onFileLoadedListeners,e)},notifyFileLoaded:function(e){this.notifyListeners(this._onFileLoadedListeners,{name:e.name,data:e.data})},addArchiveLoadedListener:function(e){this.addListener(this._onArchiveLoadedListeners,e)},notifyArchiveLoaded:function(){this.notifyListeners(this._onArchiveLoadedListeners)},setFileLocationFilter:function(e){if("function"!=typeof e)throw"Invalid filter";this._archiveLocationFilter=e},loadArchiveDescription:function(o){FileLoader.load(this._archiveLocationFilter(o),"json",void 0,function(e,o){},function(e){GameArchiveLoader.notifyFileDownloadError(o)},function(e){GameArchiveLoader.onReceiveDescription(e)})},onReceiveDescription:function(e){this._files=e.content,this._totalDownloadBytes=0;for(var o=this._currentDownloadBytes=0;o<this._files.length;++o)this._totalDownloadBytes+=this._files[o].size;this.downloadContent()},downloadContent:function(){var e=this._files[this._fileIndex];1<e.pieces.length&&(e.data=new Uint8Array(e.size));var o=e.pieces.length;void 0!==this.MAX_CONCURRENT_XHR&&(o=Math.min(o,this.MAX_CONCURRENT_XHR));for(var n=0;n<o;++n)this.downloadPiece(e,n)},notifyDownloadProgress:function(){Progress.calculateProgress(50,100,this._currentDownloadBytes,this._totalDownloadBytes)},downloadPiece:function(o,e){if(e<o.lastRequestedPiece)throw"Request out of order";var n=o.pieces[e];o.lastRequestedPiece=e;o.totalLoadedPieces=0;var t=0,e=this._archiveLocationFilter("/"+n.name);FileLoader.load(e,"arraybuffer",void 0,function(e,o){var n=e-t;t=e,GameArchiveLoader._currentDownloadBytes+=n,GameArchiveLoader.notifyDownloadProgress()},function(e){GameArchiveLoader.notifyFileDownloadError(e)},function(e){n.data=new Uint8Array(e),n.dataLength=n.data.length,n.dataLength,t=n.dataLength,GameArchiveLoader.onPieceLoaded(o,n),GameArchiveLoader.notifyDownloadProgress(),n.data=void 0})},addPieceToFile:function(e,o){if(1==e.pieces.length)e.data=o.data;else{var n=o.offset,t=n+o.data.length;if(n<0)throw"Buffer underflow";if(t>e.data.length)throw"Buffer overflow";e.data.set(o.data,o.offset)}},onPieceLoaded:function(e,o){this.addPieceToFile(e,o),++e.totalLoadedPieces,e.totalLoadedPieces==e.pieces.length?this.onFileLoaded(e):(o=e.lastRequestedPiece+1)<e.pieces.length&&this.downloadPiece(e,o)},verifyFile:function(e){for(var o=0,n=0;n<e.pieces.length;++n)o+=e.pieces[n].dataLength;if(o!=e.size)throw"Unexpected data size";if(1<e.pieces.length){e.data;for(var t=e.pieces,n=0;n<t.length;++n){var r=t[n],i=r.offset,s=i+r.dataLength;if(0<n){r=t[n-1];if(r.offset+r.dataLength>i)throw"Segment underflow"}if(t.length-2>n)if(s>t[n+1].offset)throw"Segment overflow"}}},onFileLoaded:function(e){this.verifyFile(e),this.notifyFileLoaded(e),++this._fileIndex,this._fileIndex==this._files.length?this.onArchiveLoaded():this.downloadContent()},onArchiveLoaded:function(){this.isCompleted=!0,this.notifyArchiveLoaded()}},Progress={progress_id:"defold-progress",bar_id:"defold-progress-bar",listeners:[],addListener:function(e){if("function"!=typeof e)throw"Invalid callback registration";this.listeners.push(e)},notifyListeners:function(e){for(i=0;i<this.listeners.length;++i)this.listeners[i](e)},addProgress:function(e){e.insertAdjacentHTML("afterend",'<div id="'+Progress.progress_id+'" class="canvas-app-progress"><div id="'+Progress.bar_id+'" class="canvas-app-progress-bar" style="width: 0%;"></div></div>'),Progress.bar=document.getElementById(Progress.bar_id),Progress.progress=document.getElementById(Progress.progress_id)},updateProgress:function(e){Progress.bar&&(Progress.bar.style.width=e+"%"),Progress.notifyListeners(e)},calculateProgress:function(e,o,n,t){this.updateProgress(e+n/t*(o-e))},removeProgress:function(){null!==Progress.progress.parentElement&&(Progress.progress.parentElement.removeChild(Progress.progress),Module.canvas.style.background="")}},CanvasInput={arrowKeysHandler:function(e){switch(e.keyCode){case 37:case 38:case 39:case 40:case 32:e.preventDefault(),e.stopPropagation()}},onFocusIn:function(e){window.addEventListener("keydown",CanvasInput.arrowKeysHandler,!1)},onFocusOut:function(e){window.removeEventListener("keydown",CanvasInput.arrowKeysHandler,!1)},addToCanvas:function(e){e.addEventListener("focus",CanvasInput.onFocusIn,!1),e.addEventListener("blur",CanvasInput.onFocusOut,!1),e.focus(),CanvasInput.onFocusIn()}},Module={noInitialRun:!0,_filesToPreload:[],_archiveLoaded:!1,_preLoadDone:!1,_waitingForArchive:!1,persistentStorage:!0,_syncInProgress:!1,_syncNeeded:!1,_syncInitial:!1,_syncMaxTries:3,_syncTries:0,arguments:[],print:function(e){console.log(e)},printErr:function(e){console.error(e)},setStatus:function(e){console.log(e)},isWASMSupported:function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}(),prepareErrorObject:function(e,o,n,t,r){n=(o=void 0===o?"":o)+":"+(n=void 0===n?0:n)+":"+(t=void 0===t?0:t),t=r||(void 0!==window.event?window.event.error:"")||e||"Undefined Error",r="",e="";"object"==typeof t&&void 0!==t.stack&&void 0!==t.message?(e=String(t.stack),r=String(t.message)):(r=(e=String(t).split("\n")).shift(),e=e.join("\n"));e=e||n,n=/at (\S+:\d*$)/.exec(r);return n&&(r=r.replace(/(at \S+:\d*$)/,""),e=n[1]+"\n"+e),r=r.replace(/(abort\(.+\)) at .+/,"$1"),{stack:e=(e=(e=(e=(e=e.replace(/\?{1}\S+(:\d+:\d+)/g,"$1")).replace(/ *at (\S+)$/gm,"@$1")).replace(/ *at (\S+)(?: \[as \S+\])? +\((.+)\)/g,"$1@$2")).replace(/^((?:Object|Array)\.)/gm,"")).split("\n"),message:r}},hasWebGLSupport:function(){var o=!1;try{var e=document.createElement("canvas"),e=e.getContext("webgl")||e.getContext("experimental-webgl");e&&e instanceof WebGLRenderingContext&&(o=!0)}catch(e){console.log("An error occurred while detecting WebGL support: "+e),o=!1}return o},handleVisibilityChange:function(){GLFW.onFocusChanged(document[Module.hiddenProperty]?0:1)},getHiddenProperty:function(){if("hidden"in document)return"hidden";for(var e=["webkit","moz","ms","o"],o=0;o<e.length;o++)if(e[o]+"Hidden"in document)return e[o]+"Hidden";return null},setupVisibilityChangeListener:function(){var e;Module.hiddenProperty=Module.getHiddenProperty(),Module.hiddenProperty?(e=Module.hiddenProperty.replace(/[H|h]idden/,"")+"visibilitychange",document.addEventListener(e,Module.handleVisibilityChange,!1)):console.log("No document.hidden property found. The focus events won't be enabled.")},setupCanvas:function(e){return e=void 0===e?"canvas":e,Module.canvas=document.getElementById(e),Module.canvas},runApp:function(e,o){Module.setupCanvas(e);var n,t={archive_location_filter:function(e){return"split"+e},unsupported_webgl_callback:void 0,engine_arguments:[],persistent_storage:!0,custom_heap_size:void 0,disable_context_menu:!0,retry_time:1,retry_count:10,can_not_download_file_callback:void 0};for(n in o)o.hasOwnProperty(n)&&(t[n]=o[n]);Module.arguments=t.engine_arguments,Module.persistentStorage=t.persistent_storage;e=t.full_screen_container;"string"==typeof e&&(e=document.querySelector(e)),Module.fullScreenContainer=e||Module.canvas,Module.hasWebGLSupport()?(CanvasInput.addToCanvas(Module.canvas),Module.setupVisibilityChangeListener(),t.disable_context_menu&&(Module.canvas.oncontextmenu=function(e){e.preventDefault()}),FileLoader.options.retryCount=t.retry_count,FileLoader.options.retryInterval=1e3*t.retry_time,"function"==typeof t.can_not_download_file_callback&&GameArchiveLoader.addFileDownloadErrorListener(t.can_not_download_file_callback),GameArchiveLoader.addFileLoadedListener(Module.onArchiveFileLoaded),GameArchiveLoader.addArchiveLoadedListener(Module.onArchiveLoaded),GameArchiveLoader.setFileLocationFilter(t.archive_location_filter),GameArchiveLoader.loadArchiveDescription("/archive_files.json")):(Progress.updateProgress(100,"Unable to start game, WebGL not supported"),Module.setStatus=function(e){e&&Module.printErr("[missing WebGL] "+e)},"function"==typeof t.unsupported_webgl_callback&&t.unsupported_webgl_callback())},onArchiveFileLoaded:function(e){Module._filesToPreload.push({path:e.name,data:e.data})},onArchiveLoaded:function(){GameArchiveLoader.cleanUp(),Module._archiveLoaded=!0,Progress.updateProgress(100,"Starting..."),Module._waitingForArchive&&Module._preloadAndCallMain()},toggleFullscreen:function(e){GLFW.isFullscreen?GLFW.cancelFullScreen():GLFW.requestFullScreen(e)},preSync:function(o){FS.syncfs(!0,function(e){e?(Module._syncTries+=1,console.error("FS syncfs error: "+e),Module._syncMaxTries>Module._syncTries?Module.preSync(o):(Module._syncInitial=!0,o())):(Module._syncInitial=!0,void 0!==o&&o())})},preloadAll:function(){if(!Module._preLoadDone){Module._preLoadDone=!0;for(var e=0;e<Module._filesToPreload.length;++e){var o=Module._filesToPreload[e];FS.createPreloadedFile("",o.path,o.data,!0,!0)}}},persistentSync:function(){Module._syncInitial&&(Module._syncInProgress?Module._syncNeeded=!0:Module._startSyncFS())},preInit:[function(){var o,e=DMSYS.GetUserPersistentDataRoot();FS.mkdir(e),window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,Module.persistentStorage&&window.indexedDB?(FS.mount(IDBFS,{},e),o=FS.close,FS.close=function(e){e=o(e);return Module.persistentSync(),e},Module.preSync(function(){Module._preloadAndCallMain()})):Module._preloadAndCallMain()}],preRun:[function(){Module._archiveLoaded&&Module.preloadAll()}],postRun:[function(){Module._archiveLoaded&&Progress.removeProgress()}],_preloadAndCallMain:function(){Module._archiveLoaded?(Module.preloadAll(),Progress.removeProgress(),void 0===Module.callMain?Module.noInitialRun=!1:Module.callMain(Module.arguments)):Module._waitingForArchive=!0},_startSyncFS:function(){Module._syncInProgress=!0,Module._syncMaxTries>Module._syncTries&&FS.syncfs(!1,function(e){Module._syncInProgress=!1,e&&(console.error("Module._startSyncFS error: "+e),Module._syncTries+=1),Module._syncNeeded&&(Module._syncNeeded=!1,Module._startSyncFS())})}};window.onerror=function(e,o,n,t,r){void 0!==Module.ccall&&(r=Module.prepareErrorObject(e,o,n,t,r),Module.ccall("JSWriteDump","null",["string"],[JSON.stringify(r.stack)])),Module.setStatus("Exception thrown, see JavaScript console"),Module.setStatus=function(e){e&&Module.printErr("[post-exception status] "+e)}};
//# sourceMappingURL=dmloader.js.map